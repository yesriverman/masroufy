{% extends 'base.html' %}
{% block title %}📊 قائمة المصروفات{% endblock %}
{% block content %}


<div class="container mt-2">
  <div class="card shadow-sm rounded-1">
      <div class="card-header text-white text-center " >
          <h3 class="text-center mb-2">📊 المصروفات الشهرية</h3>
      </div>
  
<!-- 🔍 Responsive Filter Form -->
<form method="get" class="row g-2 g-md-3 mb-2 mt-1 px-2 align-items-end">

  <!-- 📅 Start Date -->
  <div class="col-6 col-md-2 d-flex flex-column flex-md-column">
    <label for="start_date" class="form-label mb-1">📅 من تاريخ</label>
    <input type="date" name="start_date" id="start_date" value="{{ start_date }}" class="form-control">
  </div>

  <!-- 📅 End Date -->
  <div class="col-6 col-md-2 d-flex flex-column flex-md-column">
    <label for="end_date" class="form-label mb-1">📅 إلى تاريخ</label>
    <input type="date" name="end_date" id="end_date" value="{{ end_date }}" class="form-control">
  </div>

  <!-- 🗂️ Group -->
  <div class="col-6 col-md-2 d-flex flex-column flex-md-column">
    <label for="group" class="form-label mb-1">🗂️ المجموعة</label>
    <select name="group" id="group" class="form-select">
      <option value="">-- الكل --</option>
      {% for group in groups %}
        <option value="{{ group.id }}" {% if group.id == selected_group %}selected{% endif %}>{{ group.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- 🏷️ Label -->
  <div class="col-6 col-md-2 d-flex flex-column flex-md-column">
    <label for="label" class="form-label mb-1">🏷️ التسمية الفرعية</label>
    <select name="label" id="label" class="form-select">
      <option value="">-- الكل --</option>
      {% for label in labels %}
        <option value="{{ label.id }}" {% if label.id == selected_label %}selected{% endif %}>{{ label.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- 📊 Submit + 🔄 Reset Buttons -->
  <div class="col-12 col-md-4 d-flex gap-2">
    <button type="submit" class="btn btn-primary w-100">📊 عرض النتائج</button>
    <a href="{% url 'home' %}" class="btn btn-outline-secondary w-100">🔄 إعادة تعيين</a>
  </div>

</form> 



<!-- 📊 Summary Cards -->
<div class="row g-2 mt-2">
  <!-- 💰 Total Income -->
  <div class="col-12 col-sm-6 col-md-4">
    <div class="card text-bg-success h-100">
      <div class="card-body text-center py-3 px-2">
        <h6 class="mb-1">💰 الدخل</h6>
        <p class="fw-bold fs-5 mb-0">{{ total_income|floatformat:0 }} د.م</p>
      </div>
    </div>
  </div>

  <!-- 💸 Total Expense -->
  <div class="col-12 col-sm-6 col-md-4">
    <div class="card text-bg-danger h-100">
      <div class="card-body text-center py-3 px-2">
        <h6 class="mb-1">💸 المصاريف</h6>
        <p class="fw-bold fs-5 mb-0">{{ total_expense|floatformat:0 }} د.م</p>
      </div>
    </div>
  </div>

  <!-- 📈 Net Balance -->
  <div class="col-12 col-sm-6 col-md-4">
    <div class="card {% if balance >= 0 %}text-bg-primary{% else %}text-bg-warning{% endif %} h-100">
      <div class="card-body text-center py-3 px-2">
        <h6 class="mb-1">📈 الرصيد</h6>
        <p class="fw-bold fs-5 mb-0">{{ balance|floatformat:0 }} د.م</p>
      </div>
    </div>
  </div>
</div>
</div>

  <!-- Add Expense Button -->
  <div class="mb-2 text-end mt-2">
    <a href="{% url 'expense_add' %}?next={{ request.path }}" class="btn btn-success">➕ إضافة مصروف</a>
    <a href="{% url 'add_expense_view' %}?next={{ request.path }}" class="btn btn-success">➕  إضافة مصاريف متعددة</a>        
  </div>
<!-- Grouped Expenses Accordion -->
{% if grouped_expenses %}
  <div class="accordion" id="expenseAccordion">
    {% for label_obj, data in grouped_expenses.items %}

    {% comment %} {% for label, data in grouped_expenses.items %} {% endcomment %}
      <div class="accordion-item mb-2">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
          <button class="accordion-button collapsed px-3 py-2" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}"
                  aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">

            <div class="d-flex w-100 text-center">
              <div class="flex-grow-2 border-end pe-2" style="flex: 2;">
                <span class="fw-bold">🏷️ {{ label_obj.name }}</span>
              </div>
              <div class="flex-grow-1 border-end px-2" style="flex: 1;">
                <span>المجموع: <strong>{{ data.total|floatformat:0 }}</strong></span>
              </div>
              <div class="flex-grow-1 ps-2" style="flex: 1;">
                <span>المبلغ المتوقع: <strong>{{ label_obj.expected_monthly }} د.م</strong></span>

                {% comment %} <span>العدد: <strong>{{ data.items|length }}</strong></span> {% endcomment %}
              </div>
            </div>


          </button>
        </h2>

        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
             aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#expenseAccordion">
          <div class="accordion-body">
            <ul class="list-group">
              {% for expense in data.items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ expense.amount|floatformat:0 }}
                  <span class="badge bg-secondary">{{ expense.date|date:"D-d-m-Y" }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted mt-4 text-center">
    لا توجد مصروفات لعرضها في هذا النطاق الزمني أو التصفية المحددة.
  </p>
{% endif %}

</div>

{% endblock %}
